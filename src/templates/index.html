{% extends "base.html" %}

<head>
    {% block title %}Nuevo alumno{% endblock %}
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>

<body>

    {% block content %}

        <div class="col-md-12 container">
            <a href="/listado" style="float: right;" class="btn-guardar ">Ver Listado</a>
            <h3 class="text-left subtitulo mt-3">Nuevo alumno</h3>
        
            <div class="card-contenedor mb-3 mt-4">
                <div class="card-body">                                  
                    <form action="/agregarAlumno" method="POST" onsubmit="return validarFormulario()">
                        <div class="row mb-3">
                            <div class="col-md-3 col-sm-12">
                                <label class="label-form">Apellido <span class="campo-obligatorio">*</span></label>
                                <input type="text" class="form-control mb-3" name="apellido" id="apellido" required value="{{ form_data.apellido if form_data else '' }}">
                                <div id="apellido-error" class="error-message"></div> 
                            </div>
                            <div class="col-md-3 col-sm-12">
                                <label class="label-form">Nombre <span class="campo-obligatorio">*</span></label>
                                <input type="text" class="form-control mb-3" name="nombre" id="nombre" required value="{{ form_data.nombre if form_data else '' }}">
                                <div id="nombre-error" class="error-message"></div> 
                            </div>   
                            <div class="col-md-3 col-sm-12">
                                <label class="label-form">DNI<span class="campo-obligatorio">*</span></label>
                                <input type="number" class="form-control mb-3" name="dni" id="dni" required value="{{ form_data.dni if form_data else '' }}" oninput="validarDNI()">

                                <div id="dni-error" class="error-message" style="display: none;"></div>
                            </div>                         
                            <div class="col-md-3 col-sm-12">
                                <label class="label-form">Email <span class="campo-obligatorio">*</span></label>
                                <input type="text" class="form-control mb-3" name="email" id="email" required value="{{ form_data.email if form_data else '' }}">                            
                            </div>
                            <div class="col-md-3 col-sm-12">
                                <label class="label-form">Telefono <span class="campo-obligatorio">*</span></label>
                                <input type="number" class="form-control mb-3" name="telefono" id="telefono" pattern="[0-9]+"  required value="{{ form_data.telefono if form_data else '' }}">
                                <div id="telefono-error" class=" error-message"></div> 
                            </div>
                            <div class="col-md-3 col-sm-12">
                                <label class="label-form">Fecha de nacimiento <span class="campo-obligatorio">*</span></label>
                                <input type="date" class="form-control mb-3" name="fecha_nacimiento" id="fecha_nacimiento" required value="{{ form_data.fecha_nacimiento if form_data else '' }}">
                                <div id="fecha-nacimiento-error" class=" error-message"></div> 
                            </div>
                            <div class="col-md-3 col-sm-12">
                                <label class="label-form">Fecha de inicio <span class="campo-obligatorio">*</span></label>
                                <input type="date" class="form-control mb-3" name="fecha_inicio" id="fecha_inicio" required value="{{ form_data.fecha_inicio if form_data else '' }}">
                                <div id="fecha-inicio-error" class=" error-message"></div> 
                            </div>
                            <div class="col-md-3 col-sm-12">
                                <label class="label-form">Colegio <span class="campo-obligatorio">*</span></label>
                                <input type="text" class="form-control mb-3" name="colegio" required value="{{ form_data.colegio if form_data else '' }}">
                            </div>
                            <div class="col-md-3 col-sm-12">
                                <label class="label-form label-with-arrow">
                                    Curso <span class="campo-obligatorio">*</span>
                                    <div class="select-container">
                                        <select name="curso" class="form-control mb-3">
                                            {% for curso in cursos %}
                                                <option value="{{ curso }}">{{ curso }}</option>
                                            {% endfor %}
                                        </select>
                                        
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-caret-down-fill" viewBox="0 0 16 16">
                                            <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
                                        </svg>
                                    </div>
                                </label>
                            </div>
                            <div class="col-md-3 col-sm-12" >
                                <label class="label-form label-with-arrow">
                                    Nivel educativo <span class="campo-obligatorio">*</span>
                                    <div class="select-container">
                                        <select class="form-control mb-3" name="nivel_educativo" required>
                                            {% for nivel in niveles_educativos %}
                                                <option value="{{ nivel }}">{{ nivel }}</option>
                                            {% endfor %}
                                        </select>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-caret-down-fill" viewBox="0 0 16 16">
                                            <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
                                        </svg>
                                    </div>
                                </label>
                            </div>
                            <div class="col-md-3 col-sm-12">
                                <label class="label-form">Nombre tutor <span class="campo-obligatorio">*</span></label>
                                <input type="text" class="form-control mb-3" name="nombre_titular" id="nombre_titular" required value="{{ form_data.nombre_titular if form_data else '' }}">
                                <div id="nombre-titular-error" class=" error-message"></div> 
                            </div>
                            <div class="col-md-3 col-sm-12">
                                <label  class="label-form">Telefono tutor <span class="campo-obligatorio">*</span></label>
                                <input type="number" class="form-control mb-3" name="telefono_titular"   id="telefono_titular" maxlength="10" required value="{{ form_data.telefono_titular if form_data else '' }}">
                                <div id="telefono-titular-error" class="error-message"></div> 
                            </div>
                            <div class="col-md-3 col-sm-12">
                                DÃ­a <span class="campo-obligatorio">*</span>
                                <div class="select-container">
                                    <select class="form-control mb-3" name="dia[]" style="display: none;">
                                        {% for dia in dias_disponibles %}
                                        <option value="{{ dia }}" {% if dia in data.dia %}selected{% endif %}>{{ dia }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="checkbox-container">
                                    {% for dia in dias_disponibles %}
                                    <label>
                                        <input type="checkbox" name="dia[]" value="{{ dia }}" {% if dia in data.dia %}checked{% endif %}> {{ dia }}
                                    </label>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            
                            <div class="col-md-3 col-sm-12">
                                <label class="label-form">Horario <span class="campo-obligatorio">*</span></label>
                                <input class="form-control mb-3" type="time" id="horario" name="horario" required value="{{ form_data.horario if form_data else '' }}">
                            </div>
                            <div class="col-md-3 col-sm-12">
                                Materia <span class="campo-obligatorio">*</span>
                                <div class="select-container">
                                    <select class="form-control mb-3" name="materia[]" style="display: none;">
                                        {% for materia in materias_disponibles %}
                                            <option value="{{ materia }}" {% if materia in data.materia %}selected{% endif %}>{{ materia }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="checkbox-container">
                                    {% for materia in materias_disponibles %}
                                        <label>
                                            <input type="checkbox" name="materia[]" value="{{ materia }}" {% if materia in data.materia %}checked{% endif %}> {{ materia }}
                                        </label>
                                    {% endfor %}
                                </div>
                            </div>
                            
                                <script>
                                    function validarFormulario() {
                                        // ObtÃ©n todos los campos obligatorios
                                        var camposObligatorios = document.querySelectorAll('[required]');
                                        var todosCompletos = true;
                                    
                                        camposObligatorios.forEach(function(campo) {
                                            if (campo.value.trim() === '') {
                                                todosCompletos = false;
                                            }
                                        });
                                    
                                        if (!todosCompletos) {
                                            // Si no todos los campos obligatorios estÃ¡n completos, muestra una alerta
                                            alert('Por favor, completa todos los campos obligatorios.');
                                            return false; // Evita que se envÃ­e el formulario
                                        }
                                    
                                        // Si todos los campos obligatorios estÃ¡n completos, el formulario se enviarÃ¡
                                        return true;
                                    }
                                    </script>
                            </div>


                            <div class="text-center">
                                <div class="btn-container">
                                    <button type="button" class="btn-guardar" data-bs-toggle="modal" data-bs-target="#confirmarGuardar">Guardar alumno</button>
                                 <!-- Modal de confirmaciÃ³n para guardar un alumno -->
                                 <div class="modal fade" id="confirmarGuardar" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="exampleModalLabel">Confirmar Guardar</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>                               
                                            <div class="modal-body">
                                                Â¿EstÃ¡s seguro de guardar este alumno?
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn-guardar" style="background-color: #92BD89; color: #ffff;" data-bs-dismiss="modal">Cancelar</button>
                                                <button type="submit" class="btn-guardar">Guardar</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                </div>                 
                            </div>
                        </div>
                        {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                        <div class="alert-container" id="alert-container" style="display: none;">
                            {% with messages = get_flashed_messages(with_categories=true) %}
                            {% if messages %}
                            <div class="alert-message">
                                {% for category, message in messages %}
                                <div class="alert alert-{{ category }}">
                                    {{ message }}
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            {% endwith %}
                        </div>
                        
                        {% endif %}
                        {% endwith %}
                        
                        </form>
                    </div>
                </div>
                
             
                
            
                            
                       
                </div>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    $(document).ready(function() {
        $(".btn-guardar").click(function() {
            // Realiza una solicitud AJAX al servidor para agregar un alumno
            $.ajax({
                type: "POST",
                url: "/agregarAlumno",
                data: $("#tuFormulario").serialize(),  // AsegÃºrate de que esto coincida con el formulario real
                success: function(response) {
                    // Muestra la alerta solo si se recibe la respuesta del servidor
                    if (response && response.script) {
                        $("body").append(response.script);
                    }
                },
                error: function(error) {
                    // Manejar errores si es necesario
                }
            });
        });
    });
</script>

        <script>
        document.addEventListener('DOMContentLoaded', function() {
    function validarCampo(inputId, errorId, mensajeError, regex) {
        var input = document.getElementById(inputId);
        var error = document.getElementById(errorId);

        input.addEventListener('input', function() {
            var valor = input.value.trim();

            if (!regex.test(valor)) {
                error.style.display = 'block';
                error.textContent = mensajeError;
            } else {
                error.style.display = 'none';
            }
        });
    }

    // ExpresiÃ³n regular para validar que el campo de telÃ©fono contiene solo nÃºmeros
    var numerosRegex = /^[0-9]+$/;

    // ExpresiÃ³n regular para validar que los campos de nombre y apellido contienen solo letras y espacios
    var letrasRegex = /^[a-zA-Z\s]*$/;

    // Llama a la funciÃ³n de validaciÃ³n para el campo de nombre
    validarCampo('nombre', 'nombre-error', 'El nombre solo debe contener letras y espacios.', letrasRegex);

    // Llama a la funciÃ³n de validaciÃ³n para el campo de apellido
    validarCampo('apellido', 'apellido-error', 'El apellido solo debe contener letras y espacios.', letrasRegex);

   
    // Llama a la funciÃ³n de validaciÃ³n para el campo de nombre del tutor
    validarCampo('nombre_titular', 'nombre-titular-error', 'El nombre del tutor solo debe contener letras y espacios.', letrasRegex);


    var fechaNacimientoInput = document.getElementById('fecha_nacimiento');
    var fechaNacimientoError = document.getElementById('fecha-nacimiento-error');
    var fechaInicioInput = document.getElementById('fecha_inicio');
    var fechaInicioError = document.getElementById('fecha-inicio-error');

    // ExpresiÃ³n regular para validar que el campo de fecha de nacimiento tiene el formato correcto (YYYY-MM-DD)
    var fechaRegex = /^\d{4}-\d{2}-\d{2}$/;

    validarCampo('fecha_nacimiento', 'fecha-nacimiento-error', 'Por favor, ingresa una fecha vÃ¡lida (YYYY-MM-DD).', fechaRegex);

    fechaNacimientoInput.addEventListener('input', function() {
        var fechaNacimiento = new Date(fechaNacimientoInput.value);
        var fechaActual = new Date();
        var fechaHace6Anios = new Date();
        fechaHace6Anios.setFullYear(fechaActual.getFullYear() - 6);

        if (isNaN(fechaNacimiento.getTime())) {
            fechaNacimientoError.textContent = 'Por favor, ingresa una fecha vÃ¡lida.';
            fechaNacimientoError.style.display = 'block';
        } else {
            fechaNacimientoError.style.display = 'none';

            if (fechaNacimiento >= fechaActual) {
                fechaNacimientoError.textContent = 'La fecha de nacimiento no puede ser la fecha actual.';
                fechaNacimientoError.style.display = 'block';
            } else if (fechaNacimiento >= fechaHace6Anios) {
                fechaNacimientoError.textContent = 'La fecha de nacimiento debe ser anterior a los Ãºltimos 6 aÃ±os.';
                fechaNacimientoError.style.display = 'block';
            } else {
                fechaNacimientoError.style.display = 'none';

                // ValidaciÃ³n en comparaciÃ³n con la fecha de inicio
                var fechaInicio = new Date(fechaInicioInput.value);
                if (fechaInicio <= fechaNacimiento) {
                    fechaInicioError.textContent = 'La fecha de inicio debe ser posterior a la fecha de nacimiento.';
                    fechaInicioError.style.display = 'block';
                } else {
                    fechaInicioError.style.display = 'none';
                }
            }
        }
    });

    fechaInicioInput.addEventListener('input', function() {
        // ValidaciÃ³n en comparaciÃ³n con la fecha de nacimiento
        var fechaNacimiento = new Date(fechaNacimientoInput.value);
        var fechaInicio = new Date(fechaInicioInput.value);

        if (fechaInicio <= fechaNacimiento) {
            fechaInicioError.textContent = 'La fecha de inicio debe ser posterior a la fecha de nacimiento.';
            fechaInicioError.style.display = 'block';
        } else {
            fechaInicioError.style.display = 'none';
        }
    });

});

        </script>
        <script>
            // Muestra el contenedor de alerta
            var alertContainer = document.getElementById('alert-container');
            alertContainer.style.display = 'block';
        
            // Desaparece despuÃ©s de 5 segundos (5000 ms)
            setTimeout(function() {
                alertContainer.style.display = 'none';
            }, 5000); // Cambia este valor (5000) para ajustar la duraciÃ³n en milisegundos
        </script>
        
       <script>
        // Obtener el campo de bÃºsqueda y la tabla
        var busquedaInput = document.getElementById('busquedaInput');
        var tablaAlumnos = document.querySelector('.table');
    
        // FunciÃ³n para verificar si una cadena parece ser una fecha en formato "DD/MM/YYYY"
        function esFechaValida(texto) {
            var fechaRegex = /^\d{2}\/\d{2}\/\d{4}$/;
            return fechaRegex.test(texto);
        }
    
        // FunciÃ³n para mostrar u ocultar una fila en funciÃ³n de la coincidencia
        function mostrarOcultarFila(fila, mostrar) {
            fila.style.display = mostrar ? '' : 'none';
        }
    
        // Agregar un evento de escucha para la entrada del usuario
        busquedaInput.addEventListener('input', function() {
            var consulta = busquedaInput.value.trim().toLowerCase(); // Quitar espacios en blanco y convertir a minÃºsculas
    
            // Obtener todas las filas de la tabla
            var filas = tablaAlumnos.querySelectorAll('tbody tr');
    
            // Iterar a travÃ©s de las filas y celdas y mostrar/ocultar segÃºn la consulta
            for (var i = 0; i < filas.length; i++) {
                var fila = filas[i];
                var mostrarFila = false;
    
                // Obtener todas las celdas de la fila
                var celdas = fila.querySelectorAll('td');
    
                // Iterar a travÃ©s de las celdas y verificar si alguna contiene la consulta
                for (var j = 0; j < celdas.length; j++) {
                    var celda = celdas[j];
                    var contenidoCelda = celda.textContent.trim().toLowerCase(); // Quitar espacios y convertir a minÃºsculas
    
                    // Verificar si la consulta estÃ¡ vacÃ­a o si la celda contiene la consulta
                    if (consulta === "" || contenidoCelda.includes(consulta)) {
                        mostrarFila = true; // Mostrar la fila si se encuentra una coincidencia
                        break; // No es necesario verificar otras celdas una vez que se encuentra una coincidencia
                    }
                    
                    // Verificar si la celda contiene el nÃºmero de mes o el nombre de mes
                    var mesData = celda.getAttribute('data-mes');
                    if (mesData && (mesData == consulta || mesesMapa[consulta] == mesData)) {
                        mostrarFila = true; // Mostrar la fila si se encuentra una coincidencia
                        break; // No es necesario verificar otras celdas una vez que se encuentra una coincidencia
                    }
    
                    // Verificar si la consulta parece ser una fecha en formato "DD/MM/YYYY"
                    if (esFechaValida(consulta) && contenidoCelda.includes(consulta)) {
                        mostrarFila = true; // Mostrar la fila si se encuentra una coincidencia de fecha
                        break; // No es necesario verificar otras celdas una vez que se encuentra una coincidencia
                    }
    
                    // Buscar por dÃ­a, mes o aÃ±o individualmente
                    if (esFechaValida(contenidoCelda) && esFechaValida(consulta)) {
                        var partesFecha = contenidoCelda.split('/');
                        var partesConsulta = consulta.split('/');
                        var fecha = new Date(contenidoCelda);
                        
                        if (partesConsulta.length === 3) {
                            // BÃºsqueda por fecha completa "DD/MM/YYYY"
                            if (contenidoCelda === consulta) {
                                mostrarFila = true;
                                break;
                            }
                        } else if (partesConsulta.length === 2) {
                            // BÃºsqueda por mes y aÃ±o "MM/YYYY"
                            if (partesFecha[1] === partesConsulta[0] && partesFecha[2] === partesConsulta[1]) {
                                mostrarFila = true;
                                break;
                            }
                        } else if (partesConsulta.length === 1) {
                            // BÃºsqueda por aÃ±o "YYYY"
                            if (partesFecha[2] === partesConsulta[0]) {
                                mostrarFila = true;
                                break;
                            }
                        }
                    }
                }
    
                mostrarOcultarFila(fila, mostrarFila); // Mostrar u ocultar la fila segÃºn la coincidencia
            }
        });
    </script>     
    <script>
    function validarFormulario() {
        var camposObligatorios = document.querySelectorAll('[required]');
        var todosCompletos = true;
        camposObligatorios.forEach(function(campo) {
            if (campo.value.trim() === '') {
                todosCompletos = false;
                console.log('Campo vacÃ­o:', campo.name);
            }
        });
        if (!todosCompletos) {
            alert('Por favor, completa todos los campos obligatorios.');
            return false;
        }
        return true;
    }
    </script>           
    {% endblock %}
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // Espera a que se cargue el documento
    document.addEventListener("DOMContentLoaded", function() {
        // Obtiene el formulario
        var form = document.querySelector("form");

        // Agrega un event listener para el envÃ­o del formulario
        form.addEventListener("submit", function(event) {
            event.preventDefault(); // Evita el envÃ­o del formulario

            // AquÃ­ puedes hacer una solicitud AJAX para enviar el formulario al servidor
            // y luego mostrar el SweetAlert en la respuesta exitosa.

            // Ejemplo de una solicitud AJAX (usando Fetch API):
            fetch("/agregarAlumno", {
                method: "POST",
                body: new FormData(form)
            })
            .then(function(response) {
                if (response.ok) {
                    // El formulario se enviÃ³ con Ã©xito, muestra el SweetAlert
                    Swal.fire({
                        title: "Alumno ingresado correctamente",
                        icon: "success"
                    });
                } else {
                    // Mostrar SweetAlert con un mensaje de error si es necesario
                    Swal.fire({
                        title: "Hubo un error al ingresar al alumno",
                        text: "Por favor, intÃ©ntalo de nuevo.",
                        icon: "error"
                    });
                }
            })
            .catch(function(error) {
                console.error("Error en la solicitud: " + error);
            });
        });
    });
</script> 
</body>
